FROM ubuntu:14.04 as claws-mail-3.8.1-cve-2012-4507-common-arm
ARG nproc=1

ADD files/sources.trusty.list /etc/apt/sources.list

RUN dpkg --add-architecture armhf


RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    python \
    libtool \
    pkg-config \
    xsltproc \
    bison \
    libssh-dev \
    gcc-multilib

RUN apt-get install -y apt-file
RUN apt-file update

# bug causing conflicts between architectures
# might not be needed on 14.04
# RUN mv /usr/include/curl /usr/include/curl.bak
# RUN mv /usr/bin/curl-config /usr/bin/curl-config.bak


RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libc6:armhf 
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y linux-libc-dev:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libc6-dev:armhf 
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y cpp:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libgcrypt20-dev:armhf libgpg-error-dev:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libdb5.3:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libgcrypt11:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libp11-kit0:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libsasl2-modules-db:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libsasl2-2:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libexpat1:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libcomerr2:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libkrb5support0:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libk5crypto3:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libkrb5-3:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libgssapi-krb5-2:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libglib2.0-0:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libdbus-1-3:armhf


RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libidn11-dev:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libsqlite3-0:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libldap-2.4-2:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libcurl3-gnutls:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libetpan-dev:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libglib2.0-dev:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libgdk-pixbuf2.0-dev:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libbz2-1.0:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libssl1.0.0:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libpython2.7-minimal:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libpython2.7-stdlib:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y libgtk2.0-dev:armhf



RUN DEBIAN_FRONTEND=noninteractive apt-get install -y gcc make gcc-arm-linux-gnueabihf binutils-arm-linux-gnueabihf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y gcc-arm-linux-gnueabihf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y g++-arm-linux-gnueabihf


ENV CONFIGURE_HOST "--host=arm-linux-gnueabihf"
ENV CC  /usr/bin/arm-linux-gnueabihf-gcc
ENV CXX /usr/bin/arm-linux-gnueabihf-g++

# configure the freetype
ADD claws-mail-3.8.1-cve-2012-4507/claws-mail-3.8.1.tar.bz2 /
WORKDIR /claws-mail-3.8.1
RUN PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig ./configure --host=arm-linux-gnueabihf

#############
## unpatched
FROM claws-mail-3.8.1-cve-2012-4507-common-arm as claws-mail-3.8.1-cve-2012-4507-arm
ARG nproc=1
RUN make -j 
RUN make install

CMD (mkdir -p /build/original/) && cp /claws-mail-3.8.1/src/claws-mail /build/original/

#############
## patched
FROM claws-mail-3.8.1-cve-2012-4507-common-arm as claws-mail-3.8.1-cve-2012-4507-patched-arm
ARG nproc=1

ADD claws-mail-3.8.1-cve-2012-4507/patches /
RUN patch /claws-mail-3.8.1/src/procmime.c /procmime.c.diff

RUN make -v -j $nproc 
RUN make install
CMD (mkdir -p /build/patched) && cp  /claws-mail-3.8.1/src/claws-mail /build/patched/

