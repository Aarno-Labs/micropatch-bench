FROM ubuntu:12.10 as gimp-2.8.0-cve-2012-3236-common
ARG nproc=1

RUN sed -i -re 's/([a-z]{2}\.)?archive.ubuntu.com|security.ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list

RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    python \
    libtool \
    pkg-config \
    flex \
    bison \
    libglib2.0-dev \
    libcairo2-dev \
    libpango1.0-dev \
    intltool \
    libatk1.0-dev \
    libgtk2.0-dev \
    libtiff4-dev



ADD gimp-2.8.0-cve-2012-3236/deps/babl-0.1.10.tar.bz2 /
WORKDIR /babl-0.1.10
RUN ./configure --prefix=/usr
RUN make -j $nproc 
RUN make -j $nproc install

ADD gimp-2.8.0-cve-2012-3236/deps/gegl-0.2.0.tar.bz2 /
WORKDIR /gegl-0.2.0
RUN ./configure --prefix=/usr
RUN make -j $nproc
RUN make install

ADD gimp-2.8.0-cve-2012-3236/gimp-2.8.0.tar.bz2 /
WORKDIR /gimp-2.8.0
RUN ./configure --disable-python


#############
## unpatched
FROM gimp-2.8.0-cve-2012-3236-common as gimp-2.8.0-cve-2012-3236
ARG nproc=1
RUN make -j $nproc V=1
RUN make install

CMD (mkdir -p /build/original/) && cp /usr/local/lib/gimp/2.0/plug-ins/file-fits /build/original/

#############
## patched
FROM gimp-2.8.0-cve-2012-3236-common as gimp-2.8.0-cve-2012-3236-patched
ARG nproc=1

ADD gimp-2.8.0-cve-2012-3236/patches /
RUN patch /gimp-2.8.0/plug-ins/file-fits/fits-io.c /fits-io.c.diff

RUN make -j $nproc
RUN make install
CMD (mkdir -p /build/patched) && cp /usr/local/lib/gimp/2.0/plug-ins/file-fits /build/patched/

