FROM ubuntu:16.04 as nginx-1.4.0-cve-2013-2028-common
ARG nproc=1

RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    python \
    libtool \
    pkg-config \
    xsltproc \
    bison \
    libssl-dev
    


ADD nginx-1.4.0.tar.gz /

# tidy is built as part of php
WORKDIR /nginx-1.4.0

RUN ./auto/configure --with-debug --without-http_rewrite_module --without-http_gzip_module \
		--with-http_ssl_module

#############
## unpatched
FROM nginx-1.4.0-cve-2013-2028-common as nginx-1.4.0-cve-2013-2028
ARG nproc=1
RUN make -j $nproc
RUN make install

CMD (mkdir -p /build/original/) && cp /usr/local/nginx/sbin/nginx /build/original/

#############
## patched
FROM nginx-1.4.0-cve-2013-2028-common as nginx-1.4.0-cve-2013-2028-patched
ARG nproc=1

ADD patches /
RUN patch src/http/ngx_http_parse.c  /ngx_http_parse.c.diff

RUN make -j $nproc
RUN make install
CMD (mkdir -p /build/patched) && cp  /usr/local/nginx/sbin/nginx /build/patched/

