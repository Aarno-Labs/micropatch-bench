FROM ubuntu:16.04 as serveez-0.2.2-cve-2019-16200-common
ARG nproc=1

RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
    build-essential \
    libtool-bin \
    texinfo \
    autoconf \
    python \
    libtool \
    pkg-config \
    xsltproc \
    bison  \
    guile-2.0-dev    


ADD serveez-0.2.2.tar.gz /
ADD deps/guile-baux.tgz /

ENV PATH=$PATH:/guile-baux

WORKDIR /serveez-0.2.2
RUN ./autogen.sh
RUN ./configure


#############
## unpatched
FROM serveez-0.2.2-cve-2019-16200-common as serveez-0.2.2-cve-2019-16200
ARG nproc=1
RUN make -j $nproc
RUN make install

CMD (mkdir -p /build/original/) && cp /usr/local/bin/serveez /build/original/

#############
## patched
FROM serveez-0.2.2-cve-2019-16200-common as serveez-0.2.2-cve-2019-16200-patched
ARG nproc=1

ADD patches /
RUN patch  /serveez-0.2.2/src/http-server/http-core.h /http-core.h.diff

RUN make -j $nproc
RUN make install
CMD (mkdir -p /build/patched) && cp  /usr/local/bin/serveez /build/patched/

