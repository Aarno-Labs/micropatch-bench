FROM ubuntu:16.04 as dnsmasq-2.77-cve-2017-14493-common-arm
ARG nproc=1

#RUN sed -i -re 's/([a-z]{2}\.)?archive.ubuntu.com|security.ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list

RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    python \
    libtool \
    pkg-config \
    xsltproc \
    bison \
    gcc make gcc-arm-linux-gnueabi binutils-arm-linux-gnueabi    

ARG hostarg

ENV PATH $PATH:/opt/cross/arm-linux-musleabi/bin:/opt/cross/arm-linux-musleabi/libexec/gcc/arm-linux-musleabi/9.2.0
ENV CONFIGURE_HOST "--host=arm-linux-musleabi"
ENV CC  /usr/bin/arm-linux-gnueabi-gcc
ENV CXX /opt/cross/arm-linux-musleabi/bin/arm-linux-musleabi-g++

ADD dnsmasq-2.77-cve-2017-14493/dnsmasq-2.77.tar.gz /

WORKDIR /dnsmasq-2.77

# don't do a -j
RUN make -j $nprocs V=1

ENV binary=dnsmasq

#############
## unpatched
FROM dnsmasq-2.77-cve-2017-14493-common-arm as dnsmasq-2.77-cve-2017-14493-arm
ARG nproc=1
RUN make -j $nproc
RUN make install

CMD (mkdir -p /build/arm/original/) && cp /usr/local/sbin/$binary /build/arm/original/

#############
## patched
FROM dnsmasq-2.77-cve-2017-14493-common-arm as dnsmasq-2.77-cve-2017-14493-patched-arm
ARG nproc=1

ADD dnsmasq-2.77-cve-2017-14493/patches /
RUN patch /dnsmasq-2.77/src/rfc3315.c /rfc3315.c.diff

RUN make -j $nproc
RUN make install
CMD (mkdir -p /build/arm/patched) && cp  /usr/local/sbin/$binary /build/arm/patched/

