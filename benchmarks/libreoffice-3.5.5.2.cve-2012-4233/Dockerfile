FROM ubuntu:12.10 as libreoffice-3.5.5.2.cve-2012-4233-common
ARG nproc=1

RUN sed -i -re 's/([a-z]{2}\.)?archive.ubuntu.com|security.ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list

RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    python \
    libtool \
    pkg-config \
    flex \
    bison \
    libxml2-dev \
    libicu-dev \
    libcupsys2-dev \
    libgnomevfs2-dev \
    curl

RUN DEBIAN_FRONTEND=noninteractive apt-get build-dep -y libreoffice


ADD libreoffice-3.5.5.2.cve-2012-4233/libreoffice-core-3.5.5.2.tar.xz /
COPY libreoffice-3.5.5.2.cve-2012-4233/deps/* /libreoffice-core-3.5.5.2/src/



#ADD libreoffice-3.5.5.2.cve-2012-4233/deps/libreoffice-dictionaries-3.5.5.2.tar.xz /libreoffice-core-3.5.5.2/src

#ADD libreoffice-3.5.5.2.cve-2012-4233/deps/*.xz /libreoffice-core-3.5.5.2/src/
# ADD libreoffice-3.5.5.2.cve-2012-4233/deps/libreoffice-help-3.5.5.2.tar.xz /libreoffice-core-3.5.5.2/src
# ADD libreoffice-3.5.5.2.cve-2012-4233/deps/libreoffice-translations-3.5.5.2.tar.xz /libreoffice-core-3.5.5.2/src

WORKDIR /libreoffice-core-3.5.5.2
run ./autogen.sh
RUN ./configure --with-num-cpus=$nprocs --disable-mozilla

RUN make -j $nprocs


#############
## unpatched
FROM libreoffice-3.5.5.2.cve-2012-4233-common as libreoffice-3.5.5.2.cve-2012-4233
ARG nproc=1
RUN make install

CMD (mkdir -p /build/original/) && cp /usr/local/lib/libreoffice/program/libscfiltlo.so /build/original/

#############
## patched
FROM libreoffice-3.5.5.2.cve-2012-4233-common as libreoffice-3.5.5.2.cve-2012-4233-patched
ARG nproc=1

ADD libreoffice-3.5.5.2.cve-2012-4233/patches /
RUN patch /libreoffice-core-3.5.5.2/sc/source/filter/excel/xiescher.cxx /xiescher.cxx.diff

RUN make 
RUN make install
CMD (mkdir -p /build/patched) && cp /usr/local/lib/libreoffice/program/libscfiltlo.so /build/patched/

