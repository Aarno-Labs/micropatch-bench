FROM ubuntu:16.04 as asterisk-11.1.2-cve-2013-2685-common-arm
ARG nproc=1

ADD files/sources.xenial.list /etc/apt/sources.list

RUN dpkg --add-architecture armhf


RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    python \
    libtool \
    pkg-config \
    xsltproc \
    bison \
    libssh-dev:armhf \
    gcc-multilib



RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y libncurses-dev:armhf libsqlite3-dev:armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y g++-multilib libc6-dev-armhf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y wget

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y gcc make gcc-arm-linux-gnueabihf binutils-arm-linux-gnueabihf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y gcc-arm-linux-gnueabihf
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y g++-arm-linux-gnueabihf


ENV CONFIGURE_HOST "--host=arm-linux-gnueabihf"
ENV CC  /usr/bin/arm-linux-gnueabihf-gcc
ENV CXX /usr/bin/arm-linux-gnueabihf-g++

ADD asterisk-11.1.2-cve-2013-2685/asterisk-11.1.2.tar.gz /

# tidy is built as part of php
WORKDIR /asterisk-11.1.2

ENV	CFLAGS="-g -O2 -fno-stack-protector" 
ENV	LDFLAGS="-z muldefs"

WORKDIR /asterisk-11.1.2/res/pjproject
RUN ./aconfigure CFLAGS="-fPIC -g -O0 -fno-stack-protector" LDFLAGS="-z muldefs -fPIC" --host=arm-linux-gnueabihf -verbose
RUN make V=1 

WORKDIR /asterisk-11.1.2
RUN ./configure --disable-xmldoc CFLAGS="-fPIC -g -O2 -fno-stack-protector" LDFLAGS="-z muldefs -fPIC" --host=arm-linux-gnueabihf -verbose

ENV binary=res_format_attr_h264.so

#############
## unpatched
FROM asterisk-11.1.2-cve-2013-2685-common-arm as asterisk-11.1.2-cve-2013-2685-arm
ARG nproc=1
RUN make -j $nproc NOISY_BUILD=1 LDCONFIG=
RUN make install


CMD (mkdir -p /build/arm/original/) && cp /usr/lib/asterisk/modules/$binary /build/arm/original/

#############
## patched
FROM asterisk-11.1.2-cve-2013-2685-common-arm as asterisk-11.1.2-cve-2013-2685-patched-arm
ARG nproc=1

ADD asterisk-11.1.2-cve-2013-2685/patches /
RUN patch /asterisk-11.1.2/res/res_format_attr_h264.c /res_format_attr_h264.c.diff

RUN make -j $nproc NOISY_BUILD=1 LDCONFIG=
RUN make install
CMD (mkdir -p /build/arm/patched) && cp  /usr/lib/asterisk/modules/$binary /build/arm/patched

