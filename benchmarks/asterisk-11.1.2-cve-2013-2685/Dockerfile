FROM ubuntu:16.04 as asterisk-11.1.2-cve-2013-2685-common
ARG nproc=1

RUN dpkg --add-architecture i386


RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    python \
    libtool \
    pkg-config \
    xsltproc \
    bison \
    libssh-dev \
    gcc-multilib

RUN dpkg --add-architecture i386

RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y libncurses-dev:i386 libsqlite3-dev:i386
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y g++-multilib libc6-dev-i386
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y wget


ADD asterisk-11.1.2-cve-2013-2685/asterisk-11.1.2.tar.gz /

# tidy is built as part of php
WORKDIR /asterisk-11.1.2

ENV	CFLAGS="-g -O2 -m32 -fno-stack-protector" 
ENV	LDFLAGS="-z muldefs -m32"

WORKDIR /asterisk-11.1.2/res/pjproject
RUN ./aconfigure CFLAGS="-g -O0 -m32 -fno-stack-protector" LDFLAGS="-z muldefs -m32" --target=x86_32-unknown-linux-gnu
RUN make V=1 

WORKDIR /asterisk-11.1.2
RUN ./configure --disable-xmldoc CFLAGS="-g -O2 -m32 -fno-stack-protector" LDFLAGS="-z muldefs -m32" --host=x86_32-unknown-linux-gnu

#############
## unpatched
FROM asterisk-11.1.2-cve-2013-2685-common as asterisk-11.1.2-cve-2013-2685
ARG nproc=1
RUN make -j $nproc V=1
RUN make install

CMD (mkdir -p /build/original/) && cp /usr/lib/asterisk/modules/res_format_attr_h264.so /build/original/

#############
## patched
FROM asterisk-11.1.2-cve-2013-2685-common as asterisk-11.1.2-cve-2013-2685-patched
ARG nproc=1

ADD asterisk-11.1.2-cve-2013-2685/patches /
RUN patch /asterisk-11.1.2/res/res_format_attr_h264.c /res_format_attr_h264.c.diff

RUN make -j $nproc
RUN make install
CMD (mkdir -p /build/patched) && cp  /usr/lib/asterisk/modules/res_format_attr_h264.so /build/patched/

