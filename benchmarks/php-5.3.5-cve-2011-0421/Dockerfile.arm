FROM ubuntu:12.10 as php-5.3.5-cve-2011-0421-common-arm
ARG nproc=1

ADD files/sources.quantal.list /etc/apt/sources.list

# RUN sed -i -re 's/([a-z]{2}\.)?archive.ubuntu.com|security.ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list

RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    python \
    libtool \
    pkg-config \
    flex \
    bison \
    gcc make 

RUN dpkg --add-architecture armel
RUN DEBIAN_FRONTEND=noninteractive apt-get update

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y \
    libxml2-dev:armel \
    libicu-dev:armel


RUN DEBIAN_FRONTEND=noninteractive apt-get install -y \
    gcc-arm-linux-gnueabi g++-arm-linux-gnueabi binutils-arm-linux-gnueabi

ENV CONFIGURE_HOST "--host=arm-linux-gnueabi"
ENV CC  /usr/bin/arm-linux-gnueabi-gcc
ENV CXX /usr/bin/arm-linux-gnueabi-g++
ENV PKG_CONFIG_PATH /usr/lib/arm-linux-gnueabi/pkgconfig

ADD php-5.3.5-cve-2011-0421/php-5.3.5.tar.bz2 /
WORKDIR /php-5.3.5
ENV LDFLAGS=-lstdc++ 
RUN ./configure --host=arm-linux-gnueabi --enable-intl

#############
## unpatched
FROM php-5.3.5-cve-2011-0421-common-arm as php-5.3.5-cve-2011-0421-arm
ARG nproc=1
RUN make -j $nproc
RUN make install

CMD (mkdir -p /build/arm/original/) && cp /php-5.3.5/sapi/cli/php /build/arm/original/

#############
## patched
FROM php-5.3.5-cve-2011-0421-common-arm as php-5.3.5-cve-2011-0421-patched-arm
ARG nproc=1

ADD php-5.3.5-cve-2011-0421/patches /
RUN patch /php-5.3.5/ext/zip/lib/zip_name_locate.c /zip_name_locate.c.diff

RUN make -j $nproc
RUN make install
CMD (mkdir -p /build/arm/patched) && cp /php-5.3.5/sapi/cli/php /build/arm/patched/

