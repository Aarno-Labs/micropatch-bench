FROM ubuntu:12.10 as tidy-cve-2012-0781-common-arm
ARG nproc=1

RUN sed -i -re 's/([a-z]{2}\.)?archive.ubuntu.com|security.ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list

RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    python \
    libtool \
    pkg-config \
    xsltproc \
    bison


RUN apt-get install -y  gcc make g++-arm-linux-gnueabi gcc-arm-linux-gnueabi binutils-arm-linux-gnueabi libc6-dev-armel-cross
ENV CONFIGURE_HOST "--host=arm-linux-gnueabi"
ENV CC  /usr/bin/arm-linux-gnueabi-gcc
ENV CXX /usr/bin/arm-linux-gnueabi-g++


ADD tidy-cve-2012-0781/tidy-tidy.tar.gz /

# tidy is built as part of php
WORKDIR /tidy/build/gmake

# don't do a -j
RUN make 

#############
## unpatched
FROM tidy-cve-2012-0781-common-arm as tidy-cve-2012-0781-arm
ARG nproc=1
RUN make -j $nproc
RUN make install

CMD (mkdir -p /build/arm/original/) && cp /usr/local/bin/tidy /build/arm/original/

#############
## patched
FROM tidy-cve-2012-0781-common-arm as tidy-cve-2012-0781-patched-arm
ARG nproc=1

ADD tidy-cve-2012-0781/patches /
RUN patch /tidy/src/localize.c /localize.c.diff

RUN make -j $nproc
RUN make install
CMD (mkdir -p /build/arm/patched) && cp  /usr/local/bin/tidy /build/arm/patched/

