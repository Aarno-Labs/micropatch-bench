FROM ubuntu:16.04 as openssl-1.0.1-cve-2014-0160-common-arm
ARG nproc=1

RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    python \
    libtool \
    pkg-config \
    xsltproc \
    bison


ADD openssl-1.0.1-cve-2014-0160/openssl-1.0.1.tar.gz /

WORKDIR /openssl-1.0.1


# need patches to update makefile for parallel build
ADD openssl-1.0.1-cve-2014-0160/patches /


RUN apt-get install -y  gcc make g++-arm-linux-gnueabi gcc-arm-linux-gnueabi binutils-arm-linux-gnueabi
ENV CONFIGURE_HOST "--host=arm-linux-gnueabi"
ENV CC  /usr/bin/arm-linux-gnueabi-gcc
ENV CXX /usr/bin/arm-linux-gnueabi-g++


# allow for parallel build
RUN patch -p1 < /openssl-1.0.1-parallel-build.patch

RUN ./Configure --shared no-threads linux-armv4 




#############
## unpatched
FROM openssl-1.0.1-cve-2014-0160-common-arm as openssl-1.0.1-cve-2014-0160-arm
ARG nproc=1
RUN make -j $nproc
RUN make install_sw

CMD (mkdir -p /build/arm/original/) && cp /usr/local/ssl/lib/libssl.so.1.0.0  /build/arm/original/

#############
## patched
FROM openssl-1.0.1-cve-2014-0160-common-arm as openssl-1.0.1-cve-2014-0160-patched-arm
ARG nproc=1

RUN patch ssl/t1_lib.c /t1_lib.c.diff

RUN make -j $nproc
RUN make install_sw
CMD (mkdir -p /build/arm/patched) && cp /usr/local/ssl/lib/libssl.so.1.0.0 /build/arm/patched/

